{% extends 'base.html' %}
{% block title %}Results{% endblock %}


{% block content %}

<div class="results-section">
    <h1 class="pb-2">RESULTS</h1>
    <div class="filter-items">
        <div class="row">
            <div>
                <p><b>VideoName: </b>{{ search }}</p> 
            </div>
            <div class="mr ml">|</div>
            <div>
                <p><b>Location: </b>{{ location }}</p>
            </div>
            <div class="mr ml">|</div>
            <div>
                <p><b>Subscribers: </b>{{ min_subs }}-{{ max_subs }}</p>
            </div>
        </div>
    </div>
    <div class="filter-post">
        <div class="row space-between">
            {% for result in results %}
            <div class="post-item" data-aos="fade-up">
                <div class="post-img">
                    <iframe src="https://youtube.com/embed/{{ result.video_id }}" frameborder="0" allow="accelormeter" allowfullscreen></iframe>
                </div>
                <div class="post-info">
                    <p><b>Title: </b>
                        <span><a href="{{ result.video_link }}" target="_blank">{{ result.title }}...</a></span>
                    </p>
                    <p><b>Channel: </b> <span><a href="{{ result.channel_link }}" target="_blank">{{ result.channel }}</a></span></p>
                    <p><b>Subscribers: </b> <span>{{ result.subscribers }}</span></p>
                    <p>
                        {% if request.user.is_authenticated %}
                            {% if result.contacted %}
                                <button class="contact-btn contacted" disabled>Contacted</button>
                            {% else %}
                                <button class="contact-btn" onclick="contactChannel(this, '{{result.channel_id}}',
                                '{{result.channel}}', '{{result.video_id}}')">Contact</button>
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
            </div>
            {% endfor %}

            {% if not request.user.is_authenticated %}
                <div class="mt-3">
                    <div class="row justify-center">
                        <div class="login-info">
                            <p>
                                <a href="{% url 'login' %}">Login</a> or <a href="{% url 'register' %}">Sign Up</a> to see more results.
                            </p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
    <script>
        AOS.init({
            duration: 2000
        })

        function getCookie(cname) {
            let name = cname += '=';
            let decodedCookie = decodeURIComponent(document.cookie);
            let ca = decodedCookie.split(';');
            
            for (let i=0; i<ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return '';
        }

        function contactChannel(self, channel_id, channel_name, video_id) {
            self.classList.add('contacted')
            self.innerText = 'Contacted'
            self.setAttribute('disabled', 'true')
            const csrftoken = getCookie('csrftoken')
            fetch(`/contact/${channel_id}/`, {
                method: 'POST',
                body: JSON.stringify({'channel_name': channel_name, 'video_id': video_id}),
                headers: {'X-CSRFToken': csrftoken }
            })
            .then(response => response.json())
            .then(data => console.log(data))
        }

    </script>
{% endblock %}